# GitLab CI pipeline: build on master and publish a Release with JAR asset

stages:
  - build
  - release

variables:
  GRADLE_OPTS: "-Dorg.gradle.daemon=false"
  JAR_PATH: "app/build/libs/gabia-dev-mcp-server-1.0.0.jar"

cache:
  key: "${CI_PROJECT_PATH}-gradle-cache"
  paths:
    - .gradle/wrapper
    - .gradle/caches

build:
  stage: build
  image: gradle:8.8.0-jdk17
  rules:
    - if: "$CI_COMMIT_BRANCH == 'master'"
  script: |
    ./gradlew --version
    ./gradlew clean build
    test -f "$JAR_PATH" || (echo "Missing jar: $JAR_PATH" && exit 1)
  artifacts:
    name: "gabia-dev-mcp-server-${CI_COMMIT_SHORT_SHA}"
    expire_in: 1 week
    when: on_success
    paths:
      - "$JAR_PATH"

release:
  stage: release
  image: alpine:3.19
  rules:
    - if: "$CI_COMMIT_BRANCH == 'master'"
  needs:
    - job: build
      artifacts: true
  variables:
    TAG_NAME: "release-${CI_COMMIT_SHORT_SHA}"
  script: |
    apk add --no-cache curl jq
    test -f "$JAR_PATH" || (echo "Missing jar: $JAR_PATH (ensure build artifacts are available)" && exit 1)
    sh ci/release.sh
